---
title: "Homework 6"
author: Suhani Patel 
date: 2021-11-23
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    code_folding: hide
    theme: yeti
    highlight: haddock
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE, results = FALSE) 
```

```{r}
library(tidyverse)
library(MASS)
library(modelr)
library(mgcv)
```

# Problem 1
*****

### Load and Clean
Load and clean the data for regression analysis (i.e. convert numeric to factor where appropriate, check for missing data, etc.).
```{r}
birthweight = read_csv(file = "./data/birthweight.csv", na = c("")) %>% 
  janitor::clean_names() %>% 
    mutate(
      babysex = factor(babysex),
      frace = factor(frace),
      malform = factor(malform),
      mrace = factor(mrace))
```

### Model Building
Propose a regression model for birthweight. This model may be based on a hypothesized structure for the factors that underly birthweight, on a data-driven model-building process, or a combination of the two. Describe your modeling process  

## Backward Selection
Starting with all variables in the model, we will remove one variable at a time with the highest AIC until we have the resulting best final model. To do this, we will use stepAIC in the MASS package. 

```{r}
# Fit the full model 
full.model <- lm(bwt ~., data = birthweight)

# Stepwise regression model
step.model = stepAIC(full.model, direction = "backward", 
                      trace = FALSE) 
```

### Plot of Residuals 
show a plot of model residuals against fitted values â€“ use add_predictions and add_residuals in making this plot.
```{r}
plot = birthweight %>% 
  modelr::add_residuals(step.model) %>% 
  modelr::add_predictions(step.model) %>% 
  ggplot(aes(x = pred, y = resid)) + geom_violin()

plot

```

### Comparison of Models
Compare your model to two others:
- One using length at birth and gestational age as predictors (main effects only)
- One using head circumference, length, sex, and all interactions (including the three-way interaction) between these
```{r}
model_2 = lm(bwt ~ blength + gaweeks, data = birthweight)

model_2 = model_2 %>% 
  broom::tidy() 
```

```{r}
model_3 = lm(bwt ~ bhead + blength + babysex + bhead*blength + bhead*babysex + blength*babysex + bhead*blength*babysex, data = birthweight)

model_3 = model_3 %>% 
  broom::tidy()  
```

### Cross-validated prediction error
Make this comparison in terms of the cross-validated prediction error; use crossv_mc and functions in purrr as appropriate.

```{r}
cv_df =
  crossv_mc(birthweight, 100) 
```

```{r}
cv_df %>% pull(train) %>% .[[1]] %>% as_tibble
```

```{r}
cv_df %>% pull(test) %>% .[[1]] %>% as_tibble
```

```{r}
cv_df =
  cv_df %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))
```

```{r}
cv_df = cv_df %>% 
  mutate(
    mod_1  = map(train, ~lm(bwt ~ bhead + blength + mrace + delwt + smoken + gaweeks + ppwt + mrace + mheight + babysex + parity + fincome +  
                mrace, data = .x)),
    mod_2  = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
    mod_3  = map(train, ~lm(bwt ~ bhead + blength + babysex + bhead*blength + bhead*babysex + blength*babysex + bhead*blength*babysex, data = .x))) %>% 
  mutate(
    rmse_1 = map2_dbl(mod_1, test, ~rmse(model = .x, data = .y)),
    rmse_2 = map2_dbl(mod_2, test, ~rmse(model = .x, data = .y)),
    rmse_3 = map2_dbl(mod_3, test, ~rmse(model = .x, data = .y)))
```
*not sure if this is supposed to be a linear model 
*mutate not working 

```{r}
cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()
```


# Problem 2
*****